<!doctype html><html lang=ja dir=" auto"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraform 勉強 | dyuji.dev</title><meta name=keywords content><meta name=description content="Terraform 勉強 Introduction to Infrastructure as Code with Terraform Infrastructure as Code(IaC) Terraformはproviderと呼ばれるTerraformプラグインでAPIを呼び出し、インフラの操作をする"><meta name=author content><link rel=canonical href=https://dyuji.dev/blog/tf/gcp_tutorial_memo/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://dyuji.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dyuji.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dyuji.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dyuji.dev/apple-touch-icon.png><link rel=mask-icon href=https://dyuji.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.110.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Terraform 勉強"><meta property="og:description" content="Terraform 勉強 Introduction to Infrastructure as Code with Terraform Infrastructure as Code(IaC) Terraformはproviderと呼ばれるTerraformプラグインでAPIを呼び出し、インフラの操作をする"><meta property="og:type" content="article"><meta property="og:url" content="https://dyuji.dev/blog/tf/gcp_tutorial_memo/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-12-26T11:15:29+09:00"><meta property="article:modified_time" content="2021-12-26T11:15:29+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Terraform 勉強"><meta name=twitter:description content="Terraform 勉強 Introduction to Infrastructure as Code with Terraform Infrastructure as Code(IaC) Terraformはproviderと呼ばれるTerraformプラグインでAPIを呼び出し、インフラの操作をする"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://dyuji.dev/blog/"},{"@type":"ListItem","position":2,"name":"Terraform 勉強","item":"https://dyuji.dev/blog/tf/gcp_tutorial_memo/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraform 勉強","name":"Terraform 勉強","description":"Terraform 勉強 Introduction to Infrastructure as Code with Terraform Infrastructure as Code(IaC) Terraformはproviderと呼ばれるTerraformプラグインでAPIを呼び出し、インフラの操作をする","keywords":[],"articleBody":"Terraform 勉強 Introduction to Infrastructure as Code with Terraform Infrastructure as Code(IaC)\nTerraformはproviderと呼ばれるTerraformプラグインでAPIを呼び出し、インフラの操作をする\nAWS GCP Azureなど有名なもののproviderは作成されている 独自でproviderを作成することも可能 providerがインフラの要素をresourceとして定義\nインスタンスやネットワークなど 様々なproviderのリソースをmoduleに構成\nmoduleは再利用可能なTerraformの構成\nTerraformは宣言型\nインフラの最終状態を記述し、Terraform providerが自動で計算 Terraformでインフラ展開の流れ\nScope 適用範囲の把握 Author 構成の記述 Initialize 必要プラグインのインストール Plan 変更のプレビュー Apply 変更の実施 State file\nインフラの状態を追跡するためのソース これの状態を見て、宣言した構成と合うよう変更を加える Terraform Cloud\nGitと繋いで自動的に構成の提案したり、実行環境を用意して構成変更の競合を防いだりする Install Terraform 内容をコピペして動く Quick start tutorial nginxのdocker image作成 terraform init terraform plan terraform apply terraform destroy Build Infrastructure GCPのアカウント作成\nサービスアカウント作成\nterraform ブロック\nインフラストラクチャのプロビジョニング(準備)に必要な設定を書く provider名 providerのソース 大体公式のprovider名を指定 バージョン指定がない場合は最新のを用いる terraform { required_providers { google = { source = \"hashicorp/google\" // 指定しないときデフォルトでhashicorpのレジストリを見に行く version = \"3.5.0\" // バージョン指定がない時は最新のものを利用する } } } provider ブロック 指定したproviderの各環境に接続する設定などを記載 provider \"google\" { credentials = file(\"credential.json\") project = \"project-name\" region = \"us-central1\" zone = \"us-central1-c\" } ロックファイル(.lock.hcl) すべてのTerraform実行に一貫性を持たせるために使用される正確なprovider versionを指定 terraform fmt : フォーマットチェック terraform validate : 構文チェック メモ：GCPアカウントを作りたてだとComputeEngineAPIが有効化されていないので有効化する\nサービスアカウントの権限が足りないときは IMAと管理/IAM でプリンシパルを編集する\nterraform show // 現在の状態を表示\nhttps://github.com/github/gitignore/blob/main/Terraform.gitignore\nChange Infrastructure 実運用するときはバージョン管理を使うことを勧める Create New resource VMインスタンス作成の定義 (Resource Type).(Reference name).(field) Terraform はリソースの依存関係グラフを作成して適切な順序で作成されるよう制御 access_configブロックが存在すると引数がなくてもVMに外部IPが与えられれインターネット経由でアクセスできる こういう仕様はちゃんとドキュメントを読む resource \"google_compute_instance\" \"vm_instance\" { name = \"terraform-instance\" machine_type = \"f1-micro\" boot_disk { initialize_params { image = \"debian-cloud/debian-9\" } } network_interface { network = google_compute_network.vpc_network.name access_config { } } } tags - (Optional) インスタンスにつけるネットワークタグのリスト ネットワークタグ：VMインスタンスに適用されるファイアウォールのルールやトラフィックの経路を設定できる https://cloud.google.com/vpc/docs/add-remove-network-tags ~は変更がある個所を示す Introduce destructive changes 破壊的変更をともなうもの(ex インスタンスのimageを変更) -/+は破棄と作成を行うことを示す Destroy Infrastructure terraform destroy 管理しているインフラをすべて終了する リソースの破棄の順序も依存関係に基づいて破棄してくれる Define Input Variables Terraformは.tfのファイルをすべて読み込むため、構成ファイルに任意の名前をつけることができる .tfvars または .auto.tfvars のファイルは自動的にロードされ変数を取り扱うことができる Query Data with Output Variables 出力変数の定義 output \"ip\" { value = google_compute_instance.vm_instance.network_interface.0.network_ip } 変数の名前は他のモジュールの入力として利用される場合はTerraform変数の命名規則に準拠している必要がある terraform output ","wordCount":"1443","inLanguage":"ja","datePublished":"2021-12-26T11:15:29+09:00","dateModified":"2021-12-26T11:15:29+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://dyuji.dev/blog/tf/gcp_tutorial_memo/"},"publisher":{"@type":"Organization","name":"dyuji.dev","logo":{"@type":"ImageObject","url":"https://dyuji.dev/favicon.ico"}}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TZL48NFQQ3"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TZL48NFQQ3")</script></head><body id=" top"><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dyuji.dev/ accesskey=h title="dyuji.dev (Alt + H)">dyuji.dev</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://dyuji.dev/about title=about><span>about</span></a></li><li><a href=https://dyuji.dev/privacy title=privacy><span>privacy</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Terraform 勉強</h1><div class=post-meta><span title='2021-12-26 11:15:29 +0900 +0900'>December 26, 2021</span></div></header><div class=post-content><h1 id=terraform-勉強>Terraform 勉強<a hidden class=anchor aria-hidden=true href=#terraform-勉強>#</a></h1><h2 id=introduction-to-infrastructure-as-code-with-terraform>Introduction to Infrastructure as Code with Terraform<a hidden class=anchor aria-hidden=true href=#introduction-to-infrastructure-as-code-with-terraform>#</a></h2><ul><li><p>Infrastructure as Code(IaC)</p></li><li><p>Terraformはproviderと呼ばれるTerraformプラグインでAPIを呼び出し、インフラの操作をする</p><ul><li>AWS GCP Azureなど有名なもののproviderは作成されている</li><li>独自でproviderを作成することも可能</li></ul></li><li><p>providerがインフラの要素をresourceとして定義</p><ul><li>インスタンスやネットワークなど</li></ul></li><li><p>様々なproviderのリソースをmoduleに構成</p></li><li><p>moduleは再利用可能なTerraformの構成</p></li><li><p>Terraformは宣言型</p><ul><li>インフラの最終状態を記述し、Terraform providerが自動で計算</li></ul></li><li><p>Terraformでインフラ展開の流れ</p><ul><li>Scope 適用範囲の把握</li><li>Author 構成の記述</li><li>Initialize 必要プラグインのインストール</li><li>Plan 変更のプレビュー</li><li>Apply 変更の実施</li></ul></li><li><p>State file</p><ul><li>インフラの状態を追跡するためのソース</li><li>これの状態を見て、宣言した構成と合うよう変更を加える</li></ul></li><li><p>Terraform Cloud</p><ul><li>Gitと繋いで自動的に構成の提案したり、実行環境を用意して構成変更の競合を防いだりする</li></ul></li></ul><h2 id=install-terraform>Install Terraform<a hidden class=anchor aria-hidden=true href=#install-terraform>#</a></h2><ul><li>内容をコピペして動く</li></ul><h3 id=quick-start-tutorial>Quick start tutorial<a hidden class=anchor aria-hidden=true href=#quick-start-tutorial>#</a></h3><ul><li>nginxのdocker image作成</li></ul><pre tabindex=0><code>terraform init
terraform plan
terraform apply
terraform destroy
</code></pre><h2 id=build-infrastructure>Build Infrastructure<a hidden class=anchor aria-hidden=true href=#build-infrastructure>#</a></h2><ul><li><p>GCPのアカウント作成</p></li><li><p>サービスアカウント作成</p></li><li><p>terraform ブロック</p><ul><li>インフラストラクチャのプロビジョニング(準備)に必要な設定を書く<ul><li>provider名</li><li>providerのソース<ul><li>大体公式のprovider名を指定</li></ul></li><li>バージョン指定がない場合は最新のを用いる</li></ul></li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>google</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;hashicorp/google&#34;</span><span style=color:#75715e> // 指定しないときデフォルトでhashicorpのレジストリを見に行く
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;3.5.0&#34;</span><span style=color:#75715e> // バージョン指定がない時は最新のものを利用する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>provider ブロック<ul><li>指定したproviderの各環境に接続する設定などを記載</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;google&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>credentials</span> = file(<span style=color:#e6db74>&#34;credential.json&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>project</span> = <span style=color:#e6db74>&#34;project-name&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>region</span>  = <span style=color:#e6db74>&#34;us-central1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>zone</span>    = <span style=color:#e6db74>&#34;us-central1-c&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>ロックファイル(.lock.hcl)<ul><li>すべてのTerraform実行に一貫性を持たせるために使用される正確なprovider versionを指定</li></ul></li></ul><pre tabindex=0><code>terraform fmt : フォーマットチェック
terraform validate : 構文チェック
</code></pre><ul><li><p>メモ：GCPアカウントを作りたてだとComputeEngineAPIが有効化されていないので有効化する</p></li><li><p>サービスアカウントの権限が足りないときは IMAと管理/IAM でプリンシパルを編集する</p></li><li><p>terraform show // 現在の状態を表示</p></li></ul><p><a href=https://github.com/github/gitignore/blob/main/Terraform.gitignore>https://github.com/github/gitignore/blob/main/Terraform.gitignore</a></p><h2 id=change-infrastructure>Change Infrastructure<a hidden class=anchor aria-hidden=true href=#change-infrastructure>#</a></h2><ul><li>実運用するときはバージョン管理を使うことを勧める</li></ul><h3 id=create-new-resource>Create New resource<a hidden class=anchor aria-hidden=true href=#create-new-resource>#</a></h3><ul><li>VMインスタンス作成の定義</li><li>(Resource Type).(Reference name).(field)</li><li>Terraform はリソースの依存関係グラフを作成して適切な順序で作成されるよう制御</li><li>access_configブロックが存在すると引数がなくてもVMに外部IPが与えられれインターネット経由でアクセスできる<ul><li>こういう仕様はちゃんとドキュメントを読む</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_instance&#34;</span> <span style=color:#e6db74>&#34;vm_instance&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>         = <span style=color:#e6db74>&#34;terraform-instance&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>machine_type</span> = <span style=color:#e6db74>&#34;f1-micro&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>boot_disk</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initialize_params</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>image</span> = <span style=color:#e6db74>&#34;debian-cloud/debian-9&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network_interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>network</span> = <span style=color:#a6e22e>google_compute_network</span>.<span style=color:#a6e22e>vpc_network</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>access_config</span> {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>tags - (Optional) インスタンスにつけるネットワークタグのリスト</li><li>ネットワークタグ：VMインスタンスに適用されるファイアウォールのルールやトラフィックの経路を設定できる<ul><li><a href=https://cloud.google.com/vpc/docs/add-remove-network-tags>https://cloud.google.com/vpc/docs/add-remove-network-tags</a></li></ul></li><li><code>~</code>は変更がある個所を示す</li></ul><h3 id=introduce-destructive-changes>Introduce destructive changes<a hidden class=anchor aria-hidden=true href=#introduce-destructive-changes>#</a></h3><ul><li>破壊的変更をともなうもの(ex インスタンスのimageを変更)</li><li><code>-/+</code>は破棄と作成を行うことを示す</li></ul><h2 id=destroy-infrastructure>Destroy Infrastructure<a hidden class=anchor aria-hidden=true href=#destroy-infrastructure>#</a></h2><pre tabindex=0><code>terraform destroy
</code></pre><ul><li>管理しているインフラをすべて終了する</li><li>リソースの破棄の順序も依存関係に基づいて破棄してくれる</li></ul><h2 id=define-input-variables>Define Input Variables<a hidden class=anchor aria-hidden=true href=#define-input-variables>#</a></h2><ul><li>Terraformは.tfのファイルをすべて読み込むため、構成ファイルに任意の名前をつけることができる</li><li>.tfvars または .auto.tfvars のファイルは自動的にロードされ変数を取り扱うことができる</li></ul><h2 id=query-data-with-output-variables>Query Data with Output Variables<a hidden class=anchor aria-hidden=true href=#query-data-with-output-variables>#</a></h2><ul><li>出力変数の定義</li></ul><pre tabindex=0><code>output &#34;ip&#34; {
  value = google_compute_instance.vm_instance.network_interface.0.network_ip
}
</code></pre><ul><li>変数の名前は他のモジュールの入力として利用される場合はTerraform変数の命名規則に準拠している必要がある</li></ul><pre tabindex=0><code>terraform output
</code></pre></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://dyuji.dev/>dyuji.dev</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>